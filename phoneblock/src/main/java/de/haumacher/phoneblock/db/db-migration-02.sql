--
-- Consolidate number information from SPAMREPORTS, OLDREPORTS, RATINGS, RATINGHISTORY, SEARCHES, and SEARCHHISTORY 
-- into NUMBERS and NUMBERS_HISTORY
--

---------------------------------
-- ANSWERBOT_SIP
---------------------------------

ALTER TABLE ANSWERBOT_SIP DROP COLUMN IF EXISTS MIN_VOTES;
ALTER TABLE ANSWERBOT_SIP DROP COLUMN IF EXISTS WILDCARDS;

ALTER TABLE ANSWERBOT_SIP ADD MIN_VOTES INTEGER DEFAULT 4 NOT NULL;
ALTER TABLE ANSWERBOT_SIP ADD WILDCARDS BOOLEAN DEFAULT true NOT NULL;

---------------------------------
-- REVISION
---------------------------------

CREATE TABLE REVISION (
	ID INTEGER NOT NULL AUTO_INCREMENT,
	CREATED BIGINT NOT NULL,
	CONSTRAINT REVISION_PK PRIMARY KEY (ID)
);

INSERT INTO REVISION (ID, CREATED) (
	SELECT ID, CREATED FROM SEARCHCLUSTER 
);

ALTER TABLE REVISION ALTER COLUMN ID INTEGER GENERATED ALWAYS AS IDENTITY;
ALTER TABLE REVISION ALTER COLUMN ID RESTART WITH (
	SELECT max(ID) + 1 FROM REVISION
);

---------------------------------
-- NUMBERS
---------------------------------

CREATE TABLE NUMBERS (
	PHONE CHARACTER VARYING(100) NOT NULL,
	ADDED BIGINT DEFAULT 0 NOT NULL,
	UPDATED BIGINT DEFAULT 0 NOT NULL,
	LASTSEARCH BIGINT DEFAULT 0 NOT NULL,
	LASTPING BIGINT DEFAULT 0 NOT NULL,
	LASTMETA BIGINT DEFAULT 0 NOT NULL,
	ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	VOTES INTEGER DEFAULT 0 NOT NULL,
	DOWN_VOTES INTEGER DEFAULT 0 NOT NULL,
	UP_VOTES INTEGER DEFAULT 0 NOT NULL,
	LEGITIMATE INTEGER DEFAULT 0 NOT NULL,
	PING INTEGER DEFAULT 0 NOT NULL,
	POLL INTEGER DEFAULT 0 NOT NULL,
	ADVERTISING INTEGER DEFAULT 0 NOT NULL,
	GAMBLE INTEGER DEFAULT 0 NOT NULL,
	FRAUD INTEGER DEFAULT 0 NOT NULL,
	SEARCHES INTEGER DEFAULT 0 NOT NULL,
	SEARCHES_CURRENT INTEGER DEFAULT 0 NOT NULL,
	SEARCHES_BACKUP INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT NUMBERS_PK PRIMARY KEY (PHONE)
);

CREATE INDEX NUMBERS_ACTIVE_IDX ON NUMBERS (ACTIVE DESC,VOTES DESC);
CREATE INDEX NUMBERS_UPDATED_IDX ON NUMBERS (UPDATED DESC);
CREATE INDEX NUMBERS_SEARCHES_IDX ON NUMBERS (SEARCHES DESC);
CREATE INDEX NUMBERS_SEARCHES_CURRENT_IDX ON NUMBERS (SEARCHES_CURRENT DESC);

---------------------------------
-- TOKENS
---------------------------------

CREATE TABLE TOKENS (
	ID BIGINT NOT NULL AUTO_INCREMENT,
	USERID BIGINT NOT NULL,
	CREATED BIGINT DEFAULT 0 NOT NULL,
	PWHASH BINARY VARYING(128) NOT NULL,
	IMPLICIT BOOLEAN DEFAULT false NOT NULL,
	ACCESS_QUERY BOOLEAN DEFAULT false NOT NULL,
	ACCESS_DOWNLOAD BOOLEAN DEFAULT false NOT NULL,
	ACCESS_CARDDAV BOOLEAN DEFAULT false NOT NULL,
	ACCESS_RATE BOOLEAN DEFAULT false NOT NULL,
	ACCESS_LOGIN BOOLEAN DEFAULT false NOT NULL,
	LASTACCESS BIGINT DEFAULT 0 NOT NULL,
	USERAGENT CHARACTER VARYING(512) NOT NULL,
	CONSTRAINT TOKENS_PK PRIMARY KEY (ID)
);

ALTER TABLE TOKENS ADD CONSTRAINT TOKENS_USERS_FK FOREIGN KEY (USERID) REFERENCES USERS(ID) ON DELETE CASCADE;
CREATE INDEX TOKENS_USERID_IDX ON TOKENS (USERID,IMPLICIT DESC,LASTACCESS DESC,ID);

---------------------------------
-- PERSONALIZATION 
---------------------------------

CREATE TABLE PERSONALIZATION (
	USERID BIGINT NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	BLOCKED BOOLEAN DEFAULT true NOT NULL,
	CONSTRAINT PERSONALIZATION_PK PRIMARY KEY (USERID,PHONE)
);

CREATE INDEX PERSONALIZATION_USERID_IDX ON PERSONALIZATION (USERID,BLOCKED DESC,PHONE);

---------------------------------
-- COMMENTS
---------------------------------
ALTER TABLE COMMENTS DROP COLUMN IF EXISTS USERID;

ALTER TABLE COMMENTS ADD USERID BIGINT;


INSERT INTO PERSONALIZATION (USERID, PHONE, BLOCKED) (
	SELECT e.OWNER, e.PHONE, FALSE FROM EXCLUDES e
);
 
INSERT INTO PERSONALIZATION (USERID, PHONE, BLOCKED) (
	SELECT b.OWNER, b.PHONE, TRUE FROM BLOCKLIST b
	LEFT OUTER JOIN PERSONALIZATION e
	ON b.OWNER = e.USERID AND b.PHONE = e.PHONE
	WHERE e.PHONE IS NULL 
);

-- Clear new NUMBERS table after failed attempt
-----------------------------------------------
DELETE FROM NUMBERS ;

-- Insert votes from SPAMREPORTS and OLDREPORTS
-----------------------------------------------
INSERT INTO NUMBERS (PHONE, ADDED, UPDATED, VOTES, ACTIVE) (
	SELECT s.PHONE, s.DATEADDED, s.LASTUPDATE, s.VOTES, TRUE FROM SPAMREPORTS s
);

-- Insert old reports as active, too. The activation is computed later on with new rules.
INSERT INTO NUMBERS (PHONE, ADDED, UPDATED, VOTES, ACTIVE) (
	SELECT s.PHONE, s.DATEADDED, s.LASTUPDATE, s.VOTES, TRUE FROM OLDREPORTS s
	LEFT OUTER JOIN SPAMREPORTS x
	ON x.PHONE = s.PHONE
	WHERE x.PHONE IS NULL 
);

-- Statistics of active and inactive numbers
--------------------------------------------
SELECT COUNT(1), ACTIVE FROM NUMBERS GROUP BY ACTIVE; 

-- Move searches from SEARCHES to NUMBERS
---------------------------------------
UPDATE NUMBERS n 
SET SEARCHES = (SELECT s.COUNT FROM SEARCHES s WHERE n.PHONE = s.PHONE),
	LASTSEARCH = GREATEST(LASTSEARCH, (SELECT s.LASTUPDATE FROM SEARCHES s WHERE n.PHONE = s.PHONE)) 
WHERE EXISTS (SELECT s.COUNT FROM SEARCHES s WHERE n.PHONE = s.PHONE);

-- Move ratings from RATINGS to NUMBERS
---------------------------------------
UPDATE NUMBERS n 
SET PING = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='C_PING'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='C_PING')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='C_PING');

UPDATE NUMBERS n 
SET POLL = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='D_POLL'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='D_POLL')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='D_POLL');

UPDATE NUMBERS n 
SET ADVERTISING = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='E_ADVERTISING'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='E_ADVERTISING')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='E_ADVERTISING');

UPDATE NUMBERS n 
SET GAMBLE = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='F_GAMBLE'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='F_GAMBLE')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='F_GAMBLE');

UPDATE NUMBERS n 
SET FRAUD = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='G_FRAUD'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='G_FRAUD')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='G_FRAUD');

UPDATE NUMBERS n 
SET LEGITIMATE = (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='A_LEGITIMATE'),
	UPDATED = GREATEST(UPDATED , (SELECT s.LASTUPDATE FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='A_LEGITIMATE')) 
WHERE EXISTS (SELECT s.COUNT FROM RATINGS s WHERE n.PHONE = s.PHONE AND s.RATING='A_LEGITIMATE');

---------------------------------
-- NUMBERS_AGGREGATION_10
---------------------------------

CREATE TABLE NUMBERS_AGGREGATION_10 (
	PREFIX CHARACTER VARYING(100) NOT NULL,
	CNT INTEGER NOT NULL,
	VOTES INTEGER NOT NULL,
	CONSTRAINT NUMBERS_AGGREGATION_10_PK PRIMARY KEY (PREFIX)
);

-- Update aggregation tables
----------------------------
DELETE FROM NUMBERS_AGGREGATION_10 ;

INSERT INTO NUMBERS_AGGREGATION_10 (PREFIX, CNT, VOTES) (
	SELECT a.prefix prefix, COUNT(1) cnt, SUM(a.votes) votes FROM (
		SELECT SUBSTRING(s.PHONE, 0, LENGTH(s.phone) - 1) prefix, s.VOTES votes 
		FROM NUMBERS s
	) a
	GROUP BY a.prefix
);

---------------------------------
-- NUMBERS_AGGREGATION_100
---------------------------------

CREATE TABLE NUMBERS_AGGREGATION_100 (
	PREFIX CHARACTER VARYING(100) NOT NULL,
	CNT INTEGER NOT NULL,
	VOTES INTEGER NOT NULL,
	CONSTRAINT NUMBERS_AGGREGATION_100_PK PRIMARY KEY (PREFIX)
);

DELETE FROM NUMBERS_AGGREGATION_100 ;

INSERT INTO NUMBERS_AGGREGATION_100 (PREFIX, CNT, VOTES) (
	SELECT a.prefix prefix, COUNT(1) cnt, SUM(a.votes) votes FROM (
		SELECT SUBSTRING(s.PREFIX, 0, LENGTH(s.PREFIX) - 1) prefix, s.VOTES votes 
		FROM NUMBERS_AGGREGATION_10 s
		WHERE s.CNT >= 4
	) a
	GROUP BY a.prefix
);

---------------------------------
-- NUMBERS_HISTORY
---------------------------------

DROP TABLE NUMBERS_HISTORY IF EXISTS;

CREATE TABLE NUMBERS_HISTORY (
	RMIN INTEGER NOT NULL,
	RMAX INTEGER NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	VOTES INTEGER DEFAULT 0 NOT NULL,
	DOWN_VOTES INTEGER DEFAULT 0 NOT NULL,
	UP_VOTES INTEGER DEFAULT 0 NOT NULL,
	LEGITIMATE INTEGER DEFAULT 0 NOT NULL,
	PING INTEGER DEFAULT 0 NOT NULL,
	POLL INTEGER DEFAULT 0 NOT NULL,
	ADVERTISING INTEGER DEFAULT 0 NOT NULL,
	GAMBLE INTEGER DEFAULT 0 NOT NULL,
	FRAUD INTEGER DEFAULT 0 NOT NULL,
	SEARCHES INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT NUMBERS_HISTORY_PK PRIMARY KEY (RMAX,PHONE)
);

-- Copy SEARCHHISTORY
INSERT INTO NUMBERS_HISTORY (RMIN, RMAX, PHONE, SEARCHES) (
	SELECT s.CLUSTER, s.CLUSTER, s.PHONE, s.COUNT FROM SEARCHHISTORY s
);

-- Create missing entries required to copy RATINGHISTORY contents
INSERT INTO NUMBERS_HISTORY (RMIN, RMAX, PHONE) (
	SELECT DISTINCT s.REV, s.REV, s.PHONE FROM RATINGHISTORY s
	LEFT OUTER JOIN NUMBERS_HISTORY h ON h.RMAX = s.REV AND h.PHONE = s.PHONE
	WHERE h.PHONE IS NULL 
);

-- Move rating history to NUMBERS_HISTORY
UPDATE NUMBERS_HISTORY n 
SET LEGITIMATE = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'A_LEGITIMATE'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'A_LEGITIMATE'
);

UPDATE NUMBERS_HISTORY n 
SET PING = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'C_PING'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'C_PING'
);

UPDATE NUMBERS_HISTORY n 
SET POLL = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'D_POLL'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'D_POLL'
);

UPDATE NUMBERS_HISTORY n 
SET ADVERTISING = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'E_ADVERTISING'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'E_ADVERTISING'
);

UPDATE NUMBERS_HISTORY n 
SET GAMBLE = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'F_GAMBLE'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'F_GAMBLE'
);

UPDATE NUMBERS_HISTORY n 
SET FRAUD = (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'G_FRAUD'
)	 
WHERE EXISTS (
	SELECT s.COUNT FROM RATINGHISTORY s WHERE s.REV = n.RMAX AND s.PHONE = n.PHONE AND s.RATING = 'G_FRAUD'
);


---------------------------------
-- Import META_UPDATE
---------------------------------
UPDATE NUMBERS n SET LASTMETA = COALESCE( (SELECT u.LASTUPDATE FROM META_UPDATE u WHERE u.PHONE = n.PHONE), 0);

---------------------------------
-- Compute initial value for LASTPING
---------------------------------
UPDATE NUMBERS n
SET n.LASTPING = GREATEST(n.LASTSEARCH, n.UPDATED); 

---------------------------------
-- Initialize up and down votes.
---------------------------------
UPDATE NUMBERS SET DOWN_VOTES = VOTES WHERE VOTES > 0;
UPDATE NUMBERS SET UP_VOTES = -VOTES WHERE VOTES < 0;

UPDATE NUMBERS_HISTORY SET DOWN_VOTES = VOTES WHERE VOTES > 0;
UPDATE NUMBERS_HISTORY SET UP_VOTES = -VOTES WHERE VOTES < 0;

---------------------------------
-- Fix invalid number entries
---------------------------------
UPDATE NUMBERS 
SET PHONE = CONCAT('0', SUBSTRING(PHONE, 3, LENGTH(PHONE)))
WHERE PHONE LIKE '+49%';

UPDATE NUMBERS 
SET PHONE = CONCAT('00', SUBSTRING(PHONE, 1, LENGTH(PHONE)))
WHERE PHONE LIKE '+%';

UPDATE PERSONALIZATION 
SET PHONE = CONCAT('0', SUBSTRING(PHONE, 3, LENGTH(PHONE)))
WHERE PHONE LIKE '+49%';

UPDATE PERSONALIZATION 
SET PHONE = CONCAT('00', SUBSTRING(PHONE, 1, LENGTH(PHONE)))
WHERE PHONE LIKE '+%';

DELETE FROM NUMBERS WHERE PHONE LIKE '%+%';
DELETE FROM NUMBERS WHERE PHONE LIKE '%/%';

---------------------------------
-- Prevent numbers with only a single old vote to be added to min-votes 2 blocklists
---------------------------------
UPDATE NUMBERS SET VOTES = 1, DOWN_VOTES = DOWN_VOTES - 1 WHERE VOTES = 2; 

---------------------------------
-- Update user settings to new values.
---------------------------------
UPDATE USERS SET MIN_VOTES = 10 WHERE MIN_VOTES = 8;
UPDATE USERS SET MIN_VOTES = 100 WHERE MIN_VOTES = 20;

-- Revision ranges are completed in code.
-- History information diff is expanded in code.
